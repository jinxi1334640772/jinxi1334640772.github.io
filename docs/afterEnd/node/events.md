---
title: Node.js Events äº‹ä»¶æ¨¡å—
description: Node.js äº‹ä»¶é©±åŠ¨ç¼–ç¨‹ï¼ŒEventEmitter ç±»çš„è¯¦ç»†ä½¿ç”¨æŒ‡å—
outline: deep
---

# ğŸ¯ Node.js Events äº‹ä»¶æ¨¡å—

å¤§å¤šæ•°æ—¶å€™ä¸éœ€è¦åˆ›å»º EventEmitter å®ä¾‹ï¼Œå› ä¸ºæ”¯æŒäº‹ä»¶å“åº”çš„æ ¸å¿ƒæ¨¡å—ï¼ˆå¦‚ `fs`ã€`http` ç­‰ï¼‰éƒ½æ˜¯ EventEmitter çš„å®ä¾‹ï¼Œéƒ½æœ‰å„è‡ªå†…å®šçš„äº‹ä»¶ã€‚

æ­¤äº‹ä»¶æœºåˆ¶ç±»ä¼¼äºè§‚å¯Ÿè€…æ¨¡å¼ï¼š
- å®šä¹‰äº‹ä»¶ç›‘å¬å™¨å‡½æ•°
- é€šè¿‡ `on` æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨ï¼Œè§‚å¯Ÿäº‹ä»¶æ˜¯å¦è§¦å‘
- é€šè¿‡ `emit` æ´¾å‘äº‹ä»¶ï¼Œäº‹ä»¶ç›‘å¬å™¨è§‚æµ‹åˆ°äº‹ä»¶è§¦å‘åæ‰§è¡Œé€»è¾‘

::: tip ğŸ’¡ æç¤º
EventEmitter æ˜¯ Node.js å¼‚æ­¥äº‹ä»¶é©±åŠ¨æ¶æ„çš„åŸºç¡€ï¼Œè®¸å¤šæ ¸å¿ƒæ¨¡å—éƒ½ç»§æ‰¿è‡ªè¿™ä¸ªç±»ã€‚
:::

## ğŸ“š åŸºæœ¬ç”¨æ³•

```javascript
const events = require('events'); // å¼•å…¥ events æ¨¡å—
const eventEmitter = new events.EventEmitter(); // åˆ›å»º events å®ä¾‹

/**
 * å®šä¹‰äº‹ä»¶ç›‘å¬å™¨å‡½æ•°
 * å‚æ•°éƒ½æ˜¯ emit æ—¶ä¼ è¿‡æ¥çš„
 */
const methodsOne = (param1, param2) => {
  console.log(param1, param2, 'ç›‘å¬å™¨1');
};

const methodsTwo = (param1, param2) => {
  console.log(param1, param2, 'ç›‘å¬å™¨2');
};

/**
 * é€šè¿‡ on æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨ï¼šå¯ä»¥æ·»åŠ å¤šä¸ªç›‘å¬å™¨
 * @param {string} eventName äº‹ä»¶åç§°
 * @param {Function} handler äº‹ä»¶å¤„ç†å‡½æ•°
 */
eventEmitter.on('customEvent', methodsOne);
eventEmitter.on('customEvent', methodsTwo);

/**
 * æ³¨å†Œåªä¼šæ‰§è¡Œä¸€æ¬¡çš„ç›‘å¬å™¨
 */
eventEmitter.once('onceEventName', methodsTwo);

/**
 * é€šè¿‡ emit æ´¾å‘äº‹ä»¶
 * @param {string} eventName äº‹ä»¶åç§°
 * @param {...*} args ä¼ ç»™äº‹ä»¶ç›‘å¬å™¨çš„å‚æ•°
 */
eventEmitter.emit('customEvent', 'å‚æ•°1', 'å‚æ•°2');
```

## ğŸ› ï¸ æ ¸å¿ƒæ–¹æ³•

### setMaxListeners()

è®¾ç½®ç›‘å¬å™¨çš„æœ€å¤§ä¸ªæ•°ï¼Œé»˜è®¤æœ€å¤š 10 ä¸ªï¼š

```javascript
/**
 * è®¾ç½®ç›‘å¬å™¨çš„æœ€å¤§ä¸ªæ•°
 * @param {number} num æœ€å¤§æ•°ç›®
 */
eventEmitter.setMaxListeners(20);
```

### listeners()

è·å–æŸäº‹ä»¶çš„æ‰€æœ‰ç›‘å¬å™¨ï¼š

```javascript
/**
 * è·å–æŸäº‹ä»¶çš„æ‰€æœ‰ç›‘å¬å™¨
 * @param {string} eventName äº‹ä»¶åç§°
 * @returns {Array} äº‹ä»¶åå¯¹åº”çš„ç›‘å¬å™¨æ•°ç»„
 */
const handlerList = eventEmitter.listeners('customEvent');
console.log(handlerList); // [Function: methodsOne, Function: methodsTwo]
```

### listenerCount()

è·å–æŸä¸ªäº‹ä»¶ç›‘å¬å™¨çš„ä¸ªæ•°ï¼š

```javascript
/**
 * è·å–æŸä¸ªäº‹ä»¶ç›‘å¬å™¨çš„ä¸ªæ•°
 * @param {string} eventName äº‹ä»¶åç§°
 * @returns {number} äº‹ä»¶åå¯¹åº”çš„ç›‘å¬å™¨ä¸ªæ•°
 */
const eventNum = eventEmitter.listenerCount('customEvent');
console.log(eventNum); // 2
```

### removeListener()

ç§»é™¤æŒ‡å®šçš„äº‹ä»¶ç›‘å¬å™¨ï¼š

```javascript
/**
 * ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
 * @param {string} eventName äº‹ä»¶åç§°
 * @param {Function} handler è¦ç§»é™¤çš„ç›‘å¬å™¨
 */
eventEmitter.removeListener('customEvent', methodsOne);
```

### removeAllListeners()

ç§»é™¤æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨ï¼š

```javascript
/**
 * ç§»é™¤æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨
 * @param {Array} eventNameList è¦ç§»é™¤ç›‘å¬å™¨çš„äº‹ä»¶åå­—æ•°ç»„
 */
eventEmitter.removeAllListeners(['customEvent']);
```

## ğŸ”„ Node.js äº‹ä»¶å¾ªç¯æœºåˆ¶

Node.js çš„äº‹ä»¶å¾ªç¯åˆ†ä¸ºä»¥ä¸‹æ­¥éª¤ï¼š

### 1. åˆå§‹åŒ–é˜¶æ®µ
- åˆå§‹åŒ– Event Loop
- æ‰§è¡Œä¸»ä»£ç ï¼Œé‡åˆ°å¼‚æ­¥å¤„ç†åˆ†é…ç»™å¯¹åº”é˜Ÿåˆ—
- ä¸»ä»£ç æ‰§è¡Œå®Œæ¯•åè¿›å…¥äº‹ä»¶å¾ªç¯

### 2. å¾®ä»»åŠ¡æ‰§è¡Œ
æ‰§è¡Œä¸»ä»£ç ä¸­å‡ºç°çš„æ‰€æœ‰å¾®ä»»åŠ¡ï¼š
- å…ˆæ‰§è¡Œå®Œæ‰€æœ‰ `process.nextTick()`
- ç„¶åæ‰§è¡Œå…¶å®ƒæ‰€æœ‰å¾®ä»»åŠ¡

### 3. Event Loop å…­ä¸ªé˜¶æ®µ

```
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”Œâ”€>â”‚           timers          â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  â”‚     pending callbacks     â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  â”‚       idle, prepare       â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚   incoming:   â”‚
  â”‚  â”‚           poll            â”‚<â”€â”€â”€â”€â”€â”¤  connections, â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚   data, etc.  â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚  â”‚           check           â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â””â”€â”€â”¤      close callbacks      â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“‹ å…­ä¸ªé˜¶æ®µè¯¦è§£

| é˜¶æ®µ | è¯´æ˜ |
|------|------|
| **timers** | æ‰§è¡Œ `setTimeout()` å’Œ `setInterval()` è®¾å®šçš„å›è°ƒ |
| **pending callbacks** | æ‰§è¡Œé™¤äº† timerã€closeã€setImmediate ä¹‹å¤–çš„äº‹ä»¶å›è°ƒ |
| **idle, prepare** | ä»…ç³»ç»Ÿå†…éƒ¨ä½¿ç”¨ |
| **poll** | è½®è¯¢ï¼Œä¸æ–­æ£€æŸ¥æ–°çš„ I/O callback äº‹ä»¶ |
| **check** | æ‰§è¡Œ `setImmediate()` è®¾å®šçš„å›è°ƒ |
| **close callbacks** | æ‰§è¡Œå¦‚ `socket.on('close', ...)` çš„å›è°ƒ |

::: warning âš ï¸ æ³¨æ„
æ¯ä¸ªé˜¶æ®µæ‰§è¡Œå®Œæ¯•åï¼Œéƒ½ä¼šæ‰§è¡Œæ‰€æœ‰å¾®ä»»åŠ¡ï¼ˆå…ˆ `nextTick`ï¼Œåå…¶å®ƒï¼‰ï¼Œç„¶åå†è¿›å…¥ä¸‹ä¸€ä¸ªé˜¶æ®µã€‚
:::

## ğŸ¯ Poll é˜¶æ®µè¯¦è§£

Poll é˜¶æ®µæ˜¯æœ€å¤æ‚çš„é˜¶æ®µï¼Œä¸»è¦åˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ï¼š

1. **æ£€æŸ¥ poll queue**
   - å¦‚æœæœ‰ä»»åŠ¡å°±æŒ‰å…ˆè¿›å…ˆå‡ºçš„é¡ºåºä¾æ¬¡æ‰§è¡Œå›è°ƒ
   
2. **queue ä¸ºç©ºæ—¶**
   - æ£€æŸ¥æ˜¯å¦æœ‰ `setImmediate()` çš„ callbackï¼Œå¦‚æœæœ‰å°±è¿›å…¥ check é˜¶æ®µ
   - åŒæ—¶æ£€æŸ¥æ˜¯å¦æœ‰åˆ°æœŸçš„ timerï¼Œå¦‚æœæœ‰å°±è¿”å› timer é˜¶æ®µ

::: info ğŸ“– å…³äº process.nextTick()
`process.nextTick()` åœ¨æŠ€æœ¯ä¸Šä¸æ˜¯äº‹ä»¶å¾ªç¯çš„ä¸€éƒ¨åˆ†ã€‚ç›¸åï¼Œæ— è®ºäº‹ä»¶å¾ªç¯çš„å½“å‰é˜¶æ®µå¦‚ä½•ï¼Œéƒ½å°†åœ¨å½“å‰æ“ä½œå®Œæˆåå¤„ç† nextTickQueueã€‚
:::

## ğŸ’¡ æœ€ä½³å®è·µ

1. **åˆç†è®¾ç½®ç›‘å¬å™¨æ•°é‡**
   ```javascript
   // é¿å…å†…å­˜æ³„æ¼
   eventEmitter.setMaxListeners(20);
   ```

2. **åŠæ—¶ç§»é™¤ç›‘å¬å™¨**
   ```javascript
   // ä¸å†éœ€è¦æ—¶ç§»é™¤ç›‘å¬å™¨
   eventEmitter.removeListener('event', handler);
   ```

3. **ä½¿ç”¨ once é¿å…é‡å¤æ‰§è¡Œ**
   ```javascript
   // åªæ‰§è¡Œä¸€æ¬¡çš„äº‹ä»¶
   eventEmitter.once('init', initHandler);
   ```

4. **é”™è¯¯å¤„ç†**
   ```javascript
   eventEmitter.on('error', (err) => {
     console.error('äº‹ä»¶é”™è¯¯:', err);
   });
   ```

---

::: tip ğŸ”— ç›¸å…³é“¾æ¥
- [Node.js Events å®˜æ–¹æ–‡æ¡£](https://nodejs.org/api/events.html)
- [EventEmitter è¯¦ç»†API](https://nodejs.org/api/events.html#events_class_eventemitter)
- [äº‹ä»¶å¾ªç¯æ·±å…¥ç†è§£](https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/)
:::
