---
title: ğŸ’° å¾®ä¿¡æ”¯ä»˜å¼€å‘å®Œå…¨æŒ‡å—
description: å¾®ä¿¡æ”¯ä»˜ JSAPI æ”¯ä»˜çš„è¯¦ç»†å¼€å‘æŒ‡å—ï¼ŒåŒ…æ‹¬å•†æˆ·å·ç”³è¯·ã€ä¸‹å•æ¥å£ã€å‘èµ·æ”¯ä»˜ã€è®¢å•æŸ¥è¯¢ç­‰å®Œæ•´æµç¨‹
outline: deep
---

# ğŸ’° å¾®ä¿¡æ”¯ä»˜å¼€å‘å®Œå…¨æŒ‡å—

> å¾®ä¿¡æ”¯ä»˜æ˜¯è…¾è®¯å…¬å¸çš„æ”¯ä»˜ä¸šåŠ¡å“ç‰Œï¼Œä¸ºç”¨æˆ·æä¾›å®‰å…¨ã€å¿«æ·ã€é«˜æ•ˆçš„æ”¯ä»˜æœåŠ¡ï¼Œæœ¬æŒ‡å—è¯¦ç»†ä»‹ç»å„ç§æ”¯ä»˜æ–¹å¼çš„å®Œæ•´å¼€å‘æµç¨‹ã€‚

## ğŸ“‹ ç›®å½•å¯¼èˆª

<details>
<summary>ç‚¹å‡»å±•å¼€å®Œæ•´ç›®å½•</summary>

### ğŸ¯ å¼€å‘å‰å‡†å¤‡
- [å•†æˆ·å·ç”³è¯·ä¸é…ç½®](#å•†æˆ·å·ç”³è¯·ä¸é…ç½®)
- [å¼€å‘å‚æ•°å‡†å¤‡](#å¼€å‘å‚æ•°å‡†å¤‡)
- [å®‰å…¨é…ç½®](#å®‰å…¨é…ç½®)

### ğŸ“± JSAPIæ”¯ä»˜ï¼ˆå…¬ä¼—å·/å°ç¨‹åºï¼‰
- [æ”¯ä»˜æµç¨‹æ¦‚è¿°](#jsapiæ”¯ä»˜æµç¨‹æ¦‚è¿°)
- [ä¸‹å•æ¥å£](#jsapiä¸‹å•æ¥å£)
- [å‘èµ·æ”¯ä»˜](#jsapiå‘èµ·æ”¯ä»˜)
- [æŸ¥è¯¢è®¢å•](#jsapiæŸ¥è¯¢è®¢å•)
- [å…³é—­è®¢å•](#jsapiå…³é—­è®¢å•)
- [æ”¯ä»˜å›è°ƒ](#jsapiæ”¯ä»˜å›è°ƒ)
- [ç”³è¯·é€€æ¬¾](#jsapiç”³è¯·é€€æ¬¾)
- [æŸ¥è¯¢é€€æ¬¾](#jsapiæŸ¥è¯¢é€€æ¬¾)
- [é€€æ¬¾å›è°ƒ](#jsapié€€æ¬¾å›è°ƒ)
- [è´¦å•ä¸‹è½½](#jsapiè´¦å•ä¸‹è½½)

### ğŸ“² APPæ”¯ä»˜
- [APPæ”¯ä»˜æµç¨‹](#appæ”¯ä»˜æµç¨‹)
- [SDKé›†æˆ](#app-sdké›†æˆ)
- [ä¸‹å•ä¸è°ƒèµ·](#appä¸‹å•ä¸è°ƒèµ·)
- [å›è°ƒå¤„ç†](#appå›è°ƒå¤„ç†)

### ğŸŒ H5æ”¯ä»˜
- [H5æ”¯ä»˜æµç¨‹](#h5æ”¯ä»˜æµç¨‹)
- [åŸŸåé…ç½®](#h5åŸŸåé…ç½®)
- [è°ƒèµ·æ”¯ä»˜](#h5è°ƒèµ·æ”¯ä»˜)

### ğŸ–¥ï¸ Nativeæ”¯ä»˜ï¼ˆPCæ‰«ç ï¼‰
- [Nativeæ”¯ä»˜æµç¨‹](#nativeæ”¯ä»˜æµç¨‹)
- [äºŒç»´ç ç”Ÿæˆ](#nativeäºŒç»´ç ç”Ÿæˆ)
- [æ”¯ä»˜å¤„ç†](#nativeæ”¯ä»˜å¤„ç†)

### ğŸª ä»˜æ¬¾ç æ”¯ä»˜
- [ä»˜æ¬¾ç æ”¯ä»˜æµç¨‹](#ä»˜æ¬¾ç æ”¯ä»˜æµç¨‹)
- [å•†æˆ·æ”¶é“¶](#ä»˜æ¬¾ç å•†æˆ·æ”¶é“¶)

### ğŸ”§ å¼€å‘å·¥å…·ä¸SDK
- [å®˜æ–¹SDK](#å®˜æ–¹sdk)
- [è°ƒè¯•å·¥å…·](#è°ƒè¯•å·¥å…·)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

</details>

## ğŸ¯ å¼€å‘å‰å‡†å¤‡

### å•†æˆ·å·ç”³è¯·ä¸é…ç½®

```mermaid
graph TD
    A[ç”³è¯·å•†æˆ·å·] --> B[é€‰æ‹©ç»è¥åœºæ™¯]
    B --> C[ä¸Šä¼ èµ„è´¨ææ–™]
    C --> D[ç­‰å¾…å®¡æ ¸]
    D --> E[å®¡æ ¸é€šè¿‡]
    E --> F[å¼€é€šæ”¯ä»˜åŠŸèƒ½]
    F --> G{é€‰æ‹©æ”¯ä»˜æ–¹å¼}
    G -->|ç½‘é¡µæ”¯ä»˜| H[JSAPIæ”¯ä»˜]
    G -->|ç§»åŠ¨åº”ç”¨| I[APPæ”¯ä»˜]
    G -->|H5é¡µé¢| J[H5æ”¯ä»˜]
    G -->|PCæ‰«ç | K[Nativeæ”¯ä»˜]
    G -->|çº¿ä¸‹æ”¶é“¶| L[ä»˜æ¬¾ç æ”¯ä»˜]
```

éœ€è¦æå‰å¼€é€šå•†æˆ·å·ï¼Œé€‰æ‹©å¯¹åº”çš„ç»è¥åœºæ™¯ï¼š

![alt text](image-38.png)

å¹¶å¼€å¯å¯¹åº”çš„æ”¯ä»˜åŠŸèƒ½ï¼š

![alt text](image-37.png)

### å¼€å‘å‚æ•°å‡†å¤‡

```mermaid
graph LR
    A[å¼€å‘å‚æ•°] --> B[å•†æˆ·å· mchid]
    A --> C[åº”ç”¨ID appid]
    A --> D[APIv3å¯†é’¥]
    A --> E[å•†æˆ·APIè¯ä¹¦]
    A --> F[å¾®ä¿¡æ”¯ä»˜å¹³å°è¯ä¹¦]
    A --> G[å¾®ä¿¡æ”¯ä»˜å…¬é’¥]
    
    B --> B1[å”¯ä¸€å•†æˆ·æ ‡è¯†]
    C --> C1[å…¬ä¼—å·/å°ç¨‹åº/APPæ ‡è¯†]
    D --> D1[å›è°ƒä¿¡æ¯è§£å¯†]
    E --> E1[è¯·æ±‚ç­¾åç”Ÿæˆ]
    F --> F1[è¿”å›éªŒç­¾]
    G --> G1[æ•æ„Ÿä¿¡æ¯åŠ å¯†]
```

**æ ¸å¿ƒå‚æ•°è¯´æ˜ï¼š**

| å‚æ•° | æè¿° | ç”¨é€” |
|------|------|------|
| **å•†æˆ·å· mchid** | å•†æˆ·åœ¨å¾®ä¿¡æ”¯ä»˜ä¾§çš„å”¯ä¸€èº«ä»½æ ‡è¯† | æ‰€æœ‰æ¥å£è°ƒç”¨å¿…éœ€å‚æ•° |
| **appid** | å…¬ä¼—å·/å°ç¨‹åº/APPçš„å”¯ä¸€æ ‡è¯† | å¿…é¡»ä¸å•†æˆ·å·ç»‘å®š |
| **APIv3å¯†é’¥** | 32ä½å­—ç¬¦ä¸² | åŠ å¯†å›è°ƒä¿¡æ¯ï¼Œä¸‹è½½å¹³å°è¯ä¹¦ |
| **å•†æˆ·APIè¯ä¹¦** | å•†æˆ·ç§é’¥è¯ä¹¦ | ç”Ÿæˆè¯·æ±‚ç­¾å |
| **å¾®ä¿¡æ”¯ä»˜å¹³å°è¯ä¹¦** | å¾®ä¿¡å…¬é’¥è¯ä¹¦ | éªŒç­¾è¿”å›å†…å®¹ï¼ŒåŠ å¯†æ•æ„Ÿä¿¡æ¯ |

### å®‰å…¨é…ç½®

**å¿…éœ€çš„å®‰å…¨é…ç½®ï¼š**

- **è®¾ç½®å®‰å…¨è”ç³»äºº**ï¼šå¾®ä¿¡æ”¯ä»˜ â†’ è´¦æˆ·ä¸­å¿ƒ â†’ å®‰å…¨ä¸­å¿ƒ â†’ å®‰å…¨è”ç³»äºº
- **é…ç½®æ”¯ä»˜æˆæƒç›®å½•**ï¼šè®¾ç½®è°ƒèµ·æ”¯ä»˜çš„é¡µé¢URLè·¯å¾„
- **IPç™½åå•é…ç½®**ï¼šå¯¹å¾®ä¿¡å›è°ƒIPæ®µå¼€é€šç™½åå•
- **è¯ä¹¦ç®¡ç†**ï¼šå®šæœŸæ›´æ–°å•†æˆ·APIè¯ä¹¦

::: warning é‡è¦æé†’
- æ‰€æœ‰æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚è¯ä¹¦ç§é’¥ã€APIv3å¯†é’¥ï¼‰å¿…é¡»å¦¥å–„ä¿ç®¡ï¼Œä¸å¾—æ³„éœ²
- å»ºè®®ä½¿ç”¨HTTPSåè®®è¿›è¡Œæ‰€æœ‰æ¥å£è°ƒç”¨
- å®šæœŸæ£€æŸ¥å’Œæ›´æ–°è¯ä¹¦ï¼Œé¿å…è¿‡æœŸå¯¼è‡´æ”¯ä»˜å¤±è´¥
:::

## ğŸ“± JSAPIæ”¯ä»˜

JSAPIæ”¯ä»˜æä¾›å•†æˆ·åœ¨å¾®ä¿¡å®¢æˆ·ç«¯å†…éƒ¨æµè§ˆå™¨ç½‘é¡µä¸­ä½¿ç”¨å¾®ä¿¡æ”¯ä»˜æ”¶æ¬¾çš„èƒ½åŠ›ã€‚

### JSAPIæ”¯ä»˜æµç¨‹æ¦‚è¿°

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant M as å•†æˆ·é¡µé¢
    participant MS as å•†æˆ·æœåŠ¡å™¨
    participant WX as å¾®ä¿¡æ”¯ä»˜
    
    U->>M: 1. é€‰æ‹©å•†å“ï¼Œç‚¹å‡»æ”¯ä»˜
    M->>MS: 2. è¯·æ±‚ä¸‹å•
    MS->>WX: 3. è°ƒç”¨ä¸‹å•æ¥å£
    WX->>MS: 4. è¿”å›prepay_id
    MS->>M: 5. è¿”å›æ”¯ä»˜å‚æ•°
    M->>U: 6. è°ƒèµ·å¾®ä¿¡æ”¯ä»˜
    U->>WX: 7. ç¡®è®¤æ”¯ä»˜
    WX->>MS: 8. æ”¯ä»˜ç»“æœå›è°ƒ
    WX->>U: 9. è¿”å›æ”¯ä»˜ç»“æœ
    U->>M: 10. å›åˆ°å•†æˆ·é¡µé¢
```

**è®¢å•çŠ¶æ€æµè½¬ï¼š**

```mermaid
graph LR
    A[æœªæ”¯ä»˜ NOTPAY] --> B[æ”¯ä»˜ä¸­ USERPAYING]
    B --> C[æ”¯ä»˜æˆåŠŸ SUCCESS]
    B --> D[æ”¯ä»˜å¤±è´¥ PAYERROR]
    A --> E[å·²å…³é—­ CLOSED]
    C --> F[è½¬å…¥é€€æ¬¾ REFUND]
    A --> G[å·²æ’¤é”€ REVOKED]
```

![alt text](image-29.png)

**ä¸šåŠ¡æµç¨‹è¯¦å›¾ï¼š**
![alt text](image-30.png)

### JSAPIä¸‹å•æ¥å£

ç”¨æˆ·åœ¨å¾®ä¿¡å†…ç½®æµè§ˆå™¨è®¿é—®å•†æˆ·ç½‘é¡µå¹¶é€‰æ‹©å¾®ä¿¡æ”¯ä»˜åï¼Œå•†æˆ·éœ€è°ƒç”¨è¯¥æ¥å£åœ¨å¾®ä¿¡æ”¯ä»˜ä¸‹å•ï¼Œç”Ÿæˆç”¨äºè°ƒèµ·æ”¯ä»˜çš„é¢„æ”¯ä»˜äº¤æ˜“ä¼šè¯æ ‡è¯†(prepay_id)ã€‚

![alt text](image-31.png)

**æ¥å£ä¿¡æ¯ï¼š**
- **è¯·æ±‚æ–¹å¼**ï¼š`POST`
- **è¯·æ±‚URL**ï¼š`https://api.mch.weixin.qq.com/v3/pay/transactions/jsapi`
- **è¯·æ±‚åŸŸå**ï¼šä½¿ç”¨ä¸»åŸŸåå°†è®¿é—®å°±è¿‘çš„æ¥å…¥ç‚¹

**è¯·æ±‚å¤´è®¾ç½®ï¼š**

```bash
# ç­¾åè®¤è¯ç”Ÿæˆè®¤è¯ä¿¡æ¯
Authorization: WECHATPAY2-SHA256-RSA2048 mchid="1900000001",...
Accept: application/json
Content-Type: application/json
```

**è¯·æ±‚å‚æ•°è¯¦è§£ï¼š**

```js
  {
  // ğŸ”¸ å¿…éœ€å‚æ•°
  "appid": "wxd678efh567hg6787",              // å…¬ä¼—å·ID
  "mchid": "1230000109",                     // å•†æˆ·å·
  "description": "Imageå½¢è±¡åº—-æ·±åœ³è…¾å¤§-QQå…¬ä»”",  // å•†å“æè¿°
  "out_trade_no": "1217752501201407033233368018", // å•†æˆ·è®¢å•å·
  "notify_url": "https://www.weixin.qq.com/wxpay/pay.php", // å›è°ƒåœ°å€
  
  // ğŸ”¸ è®¢å•é‡‘é¢
  "amount": {
    "total": 100,                            // æ€»é‡‘é¢ï¼ˆåˆ†ï¼‰
    "currency": "CNY"                        // å¸ç§ï¼Œå›ºå®šCNY
  },
  
  // ğŸ”¸ æ”¯ä»˜è€…ä¿¡æ¯
  "payer": {
    "openid": "ovqdowRIfstpQK_kYShFS2MSS9XS" // ç”¨æˆ·OpenID
  },
  
  // ğŸ”¹ å¯é€‰å‚æ•°
  "time_expire": "2018-06-08T10:34:56+08:00", // æ”¯ä»˜æˆªæ­¢æ—¶é—´
  "attach": "è‡ªå®šä¹‰æ•°æ®è¯´æ˜",                    // å•†æˆ·æ•°æ®åŒ…
  "goods_tag": "WXG",                          // è®¢å•ä¼˜æƒ æ ‡è®°
  "support_fapiao": false,                     // ç”µå­å‘ç¥¨å¼€å…³
  
  // ğŸ”¹ ä¼˜æƒ è¯¦æƒ…
  "detail": {
    "cost_price": 608800,                      // è®¢å•åŸä»·
    "invoice_id": "å¾®ä¿¡123",                   // å•†å“å°ç¥¨ID
    "goods_detail": [{
      "merchant_goods_id": "1246464644",       // å•†æˆ·å•†å“ç¼–ç 
      "wechatpay_goods_id": "1001",           // å¾®ä¿¡å•†å“ç¼–ç 
      "goods_name": "iPhoneX 256G",           // å•†å“åç§°
      "quantity": 1,                          // å•†å“æ•°é‡
      "unit_price": 528800                    // å•†å“å•ä»·ï¼ˆåˆ†ï¼‰
    }]
  },
  
  // ğŸ”¹ åœºæ™¯ä¿¡æ¯
  "scene_info": {
    "payer_client_ip": "14.23.150.211",      // ç”¨æˆ·IP
    "device_id": "013467007045764",           // è®¾å¤‡å·
    "store_info": {
      "id": "0001",                           // é—¨åº—ç¼–å·
      "name": "è…¾è®¯å¤§å¦åˆ†åº—",                  // é—¨åº—åç§°
      "area_code": "440305",                  // åœ°åŒºç¼–ç 
      "address": "å¹¿ä¸œçœæ·±åœ³å¸‚å—å±±åŒºç§‘æŠ€ä¸­ä¸€é“10000å·" // è¯¦ç»†åœ°å€
    }
  },
  
  // ğŸ”¹ ç»“ç®—ä¿¡æ¯
  "settle_info": {
    "profit_sharing": false                   // æ˜¯å¦åˆ†è´¦
    }
  }
```

**å‚æ•°æ ¡éªŒè§„åˆ™ï¼š**

| å‚æ•° | æ ¼å¼è¦æ±‚ | è¯´æ˜ |
|------|----------|------|
| `out_trade_no` | 6-32ä½å­—ç¬¦ï¼Œæ•°å­—ã€å­—æ¯ã€`_-|*` | åŒä¸€å•†æˆ·å·ä¸‹å”¯ä¸€ |
| `description` | 1-127ä¸ªå­—ç¬¦ | ç”¨æˆ·è´¦å•å•†å“å­—æ®µæ˜¾ç¤º |
| `total` | æ­£æ•´æ•° | å•ä½ï¼šåˆ†ï¼Œæœ€å°å€¼1 |
| `openid` | ç”¨æˆ·åœ¨appidä¸‹çš„å”¯ä¸€æ ‡è¯† | ä¸‹å•å‰éœ€å…ˆè·å– |
| `notify_url` | HTTPS URL | å¿…é¡»ä¸ºå¤–ç½‘å¯è®¿é—® |

**åº”ç­”å‚æ•°ï¼š**

```js
{
  "prepay_id": "wx201410272009395522657a690389285100" // é¢„æ”¯ä»˜äº¤æ˜“ä¼šè¯æ ‡è¯†
}
```

::: tip å¼€å‘æç¤º
- `prepay_id` æœ‰æ•ˆæœŸä¸º2å°æ—¶ï¼Œè¿‡æœŸéœ€é‡æ–°è·å–
- å»ºè®®åœ¨è·å–OpenIDåç«‹å³è°ƒç”¨ä¸‹å•æ¥å£
- å•†æˆ·è®¢å•å·å»ºè®®ä½¿ç”¨æ—¶é—´æˆ³+éšæœºæ•°ä¿è¯å”¯ä¸€æ€§
:::

### JSAPIå‘èµ·æ”¯ä»˜

å•†æˆ·é€šè¿‡JSAPIä¸‹å•æ¥å£è·å–åˆ°å‘èµ·æ”¯ä»˜çš„å¿…è¦å‚æ•°`prepay_id`åï¼Œå†é€šè¿‡å¾®ä¿¡æµè§ˆå™¨å†…ç½®å¯¹è±¡æ–¹æ³•è°ƒèµ·å¾®ä¿¡æ”¯ä»˜æ”¶é“¶å°ã€‚

![alt text](image-32.png)

**æ”¯ä»˜å‚æ•°ç­¾åç®—æ³•ï¼š**

```mermaid
graph TD
    A[å‡†å¤‡ç­¾åå‚æ•°] --> B[appId]
    A --> C[timeStamp]
    A --> D[nonceStr]
    A --> E[package]
    
    B --> F[æ„é€ ç­¾åå­—ç¬¦ä¸²]
    C --> F
    D --> F
    E --> F
    
    F --> G[ä½¿ç”¨å•†æˆ·ç§é’¥RSAç­¾å]
    G --> H[Base64ç¼–ç ]
    H --> I[å¾—åˆ°paySign]
```

**è°ƒèµ·æ”¯ä»˜ä»£ç å®ç°ï¼š**

```js
function onBridgeReady() {
  WeixinJSBridge.invoke(
    "getBrandWCPayRequest",
    {
      appId: "wx2421b1c4370ec43b",     // å…¬ä¼—å·ID
      timeStamp: "1395712654",         // æ—¶é—´æˆ³ï¼ˆç§’ï¼‰
      nonceStr: "e61463f8efa94090b1f366cccfbbb444", // éšæœºä¸²
      package: "prepay_id=wx21201855730335ac86f8c43d1889123400", // é¢„æ”¯ä»˜è®¢å•
      signType: "RSA",                 // ç­¾åç±»å‹ï¼Œå›ºå®šRSA
      paySign: "oR9d8PuhnIc+YZ8cBHFCwfgpaK9gd7vaRvkYD7rthRAZ..." // ç­¾å
    },
    function (res) {
      // ğŸ”¸ æ”¯ä»˜ç»“æœå¤„ç†
      if (res.err_msg == "get_brand_wcpay_request:ok") {
        // âœ… æ”¯ä»˜æˆåŠŸ - è°ƒç”¨åç«¯æŸ¥å•æ¥å£ç¡®è®¤
        console.log("æ”¯ä»˜æˆåŠŸï¼Œæ­£åœ¨ç¡®è®¤è®¢å•çŠ¶æ€...");
        checkOrderStatus(); // å»ºè®®è°ƒç”¨æŸ¥å•æ¥å£äºŒæ¬¡ç¡®è®¤
      } else if (res.err_msg == "get_brand_wcpay_request:cancel") {
        // âŒ ç”¨æˆ·å–æ¶ˆæ”¯ä»˜
        console.log("ç”¨æˆ·å–æ¶ˆæ”¯ä»˜");
        showCancelMessage();
      } else if (res.err_msg == "get_brand_wcpay_request:fail") {
        // âŒ æ”¯ä»˜å¤±è´¥
        console.log("æ”¯ä»˜å¤±è´¥ï¼š" + res.err_desc);
        showFailMessage();
      }
    }
  );
}

// ğŸ”¸ å¾®ä¿¡JS-SDKåŠ è½½æ£€æµ‹
if (typeof WeixinJSBridge == "undefined") {
  if (document.addEventListener) {
    document.addEventListener("WeixinJSBridgeReady", onBridgeReady, false);
  } else if (document.attachEvent) {
    document.attachEvent("WeixinJSBridgeReady", onBridgeReady);
    document.attachEvent("onWeixinJSBridgeReady", onBridgeReady);
  }
} else {
  onBridgeReady();
}

// ğŸ”¸ è®¢å•çŠ¶æ€ç¡®è®¤å‡½æ•°
function checkOrderStatus() {
  fetch('/api/order/status', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      out_trade_no: 'å•†æˆ·è®¢å•å·'
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.trade_state === 'SUCCESS') {
      // æ”¯ä»˜ç¡®è®¤æˆåŠŸï¼Œè·³è½¬æˆåŠŸé¡µé¢
      window.location.href = '/success.html';
    } else {
      // æ”¯ä»˜çŠ¶æ€å¼‚å¸¸ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
      showErrorMessage('æ”¯ä»˜çŠ¶æ€å¼‚å¸¸ï¼Œè¯·è”ç³»å®¢æœ');
    }
  });
}
```

::: warning é‡è¦æé†’
- å‰ç«¯å›è°ƒä¸èƒ½å®Œå…¨ä¾èµ–ï¼Œå¿…é¡»é€šè¿‡åç«¯æŸ¥å•æ¥å£ç¡®è®¤æ”¯ä»˜çŠ¶æ€
- å»ºè®®åœ¨æ”¯ä»˜æˆåŠŸåç«‹å³è°ƒç”¨æŸ¥å•æ¥å£è¿›è¡ŒäºŒæ¬¡ç¡®è®¤
- ç­¾åç®—æ³•å¿…é¡»ä¸¥æ ¼æŒ‰ç…§å¾®ä¿¡æ”¯ä»˜è§„èŒƒå®ç°
:::

### JSAPIæŸ¥è¯¢è®¢å•

è®¢å•æ”¯ä»˜æˆåŠŸåï¼Œå•†æˆ·å¯é€šè¿‡å¾®ä¿¡äº¤æ˜“è®¢å•å·æˆ–å•†æˆ·è®¢å•å·æŸ¥è¯¢è®¢å•çŠ¶æ€ã€‚

![alt text](image-33.png)

**æŸ¥è¯¢æ–¹å¼å¯¹æ¯”ï¼š**

| æŸ¥è¯¢æ–¹å¼ | ä½¿ç”¨åœºæ™¯ | ä¼˜åŠ¿ | é™åˆ¶ |
|----------|----------|------|------|
| å¾®ä¿¡æ”¯ä»˜è®¢å•å· | æ”¯ä»˜æˆåŠŸå | å¾®ä¿¡ç³»ç»Ÿå”¯ä¸€æ ‡è¯† | éœ€è¦æ”¯ä»˜æˆåŠŸæ‰è¿”å› |
| å•†æˆ·è®¢å•å· | ä»»ä½•æ—¶å€™ | å•†æˆ·ç³»ç»Ÿå¯æ§ | éœ€è¦ä¼ å…¥å•†æˆ·å· |

**1. é€šè¿‡å¾®ä¿¡æ”¯ä»˜è®¢å•å·æŸ¥è¯¢ï¼š**

```bash
GET /v3/pay/transactions/id/{transaction_id}?mchid={mchid}
Host: api.mch.weixin.qq.com
Authorization: WECHATPAY2-SHA256-RSA2048 mchid="1900000001",...
Accept: application/json
```

**2. é€šè¿‡å•†æˆ·è®¢å•å·æŸ¥è¯¢ï¼š**

```bash
GET /v3/pay/transactions/out-trade-no/{out_trade_no}?mchid={mchid}
Host: api.mch.weixin.qq.com
Authorization: WECHATPAY2-SHA256-RSA2048 mchid="1900000001",...
Accept: application/json
```

**åº”ç­”å‚æ•°è¯¦è§£ï¼š**

```js
{
  "appid": "wxd678efh567hg6787",
  "mchid": "1230000109",
  "out_trade_no": "1217752501201407033233368018",  // å•†æˆ·è®¢å•å·
  "transaction_id": "1217752501201407033233368018", // å¾®ä¿¡æ”¯ä»˜è®¢å•å·
  "trade_type": "JSAPI",                           // äº¤æ˜“ç±»å‹
  "trade_state": "SUCCESS",                        // äº¤æ˜“çŠ¶æ€
  "trade_state_desc": "æ”¯ä»˜æˆåŠŸ",                   // çŠ¶æ€æè¿°
  "bank_type": "CMC",                              // é“¶è¡Œç±»å‹
  "attach": "è‡ªå®šä¹‰æ•°æ®",                            // å•†æˆ·æ•°æ®åŒ…
  "success_time": "2018-06-08T10:34:56+08:00",    // æ”¯ä»˜å®Œæˆæ—¶é—´
  
  // ğŸ”¸ æ”¯ä»˜è€…ä¿¡æ¯
  "payer": {
    "openid": "oUpF8uMuAJO_M2pxb1Q9zNjWeS6o"
  },
  
  // ğŸ”¸ é‡‘é¢ä¿¡æ¯
  "amount": {
    "total": 100,                                  // æ€»é‡‘é¢
    "payer_total": 90,                            // ç”¨æˆ·å®é™…æ”¯ä»˜é‡‘é¢
    "currency": "CNY",                            // å¸ç§
    "payer_currency": "CNY"                       // ç”¨æˆ·æ”¯ä»˜å¸ç§
  },
  
  // ğŸ”¸ åœºæ™¯ä¿¡æ¯
  "scene_info": {
    "device_id": "013467007045764"
  },
  
  // ğŸ”¸ ä¼˜æƒ è¯¦æƒ…ï¼ˆå¦‚æœ‰ä½¿ç”¨ä»£é‡‘åˆ¸ï¼‰
  "promotion_detail": [{
    "coupon_id": "109519",                         // åˆ¸ID
    "name": "å•å“æƒ -6",                            // ä¼˜æƒ åç§°
    "scope": "SINGLE",                             // ä¼˜æƒ èŒƒå›´
    "type": "CASH",                                // ä¼˜æƒ ç±»å‹
    "amount": 10,                                  // ä¼˜æƒ é‡‘é¢
    "stock_id": "931386",                          // æ´»åŠ¨ID
    "wechatpay_contribute": 0,                     // å¾®ä¿¡å‡ºèµ„
    "merchant_contribute": 10,                     // å•†æˆ·å‡ºèµ„
    "other_contribute": 0,                         // å…¶ä»–å‡ºèµ„
    "currency": "CNY",                             // ä¼˜æƒ å¸ç§
    "goods_detail": [{
      "goods_id": "M1006",                         // å•†å“ç¼–ç 
      "quantity": 1,                               // å•†å“æ•°é‡
      "unit_price": 100,                           // å•†å“å•ä»·
      "discount_amount": 10,                       // å•†å“ä¼˜æƒ é‡‘é¢
      "goods_remark": "å•†å“å¤‡æ³¨ä¿¡æ¯"                // å•†å“å¤‡æ³¨
    }]
  }]
}
```

**äº¤æ˜“çŠ¶æ€è¯´æ˜ï¼š**

| çŠ¶æ€ | è¯´æ˜ | åç»­å¤„ç† |
|------|------|----------|
| `SUCCESS` | æ”¯ä»˜æˆåŠŸ | å‘è´§/æä¾›æœåŠ¡ |
| `REFUND` | è½¬å…¥é€€æ¬¾ | å…³æ³¨é€€æ¬¾çŠ¶æ€ |
| `NOTPAY` | æœªæ”¯ä»˜ | å¯å…³é—­è®¢å• |
| `CLOSED` | å·²å…³é—­ | é‡æ–°ä¸‹å• |
| `REVOKED` | å·²æ’¤é”€ | é‡æ–°ä¸‹å• |
| `USERPAYING` | ç”¨æˆ·æ”¯ä»˜ä¸­ | ç»§ç»­æŸ¥è¯¢ |
| `PAYERROR` | æ”¯ä»˜å¤±è´¥ | é‡æ–°ä¸‹å• |

![alt text](image-35.png)

### JSAPIå…³é—­è®¢å•

å¯¹äºæœªæ”¯ä»˜çŠ¶æ€çš„è®¢å•ï¼Œå•†æˆ·å¯åœ¨ä¸éœ€è¦æ”¯ä»˜æ—¶è°ƒç”¨æ­¤æ¥å£å…³é—­è®¢å•ã€‚

**å¸¸è§å…³å•åœºæ™¯ï¼š**

```mermaid
graph TD
    A[å…³å•åœºæ™¯] --> B[ç”¨æˆ·ä¸»åŠ¨å–æ¶ˆ]
    A --> C[è®¢å•è¶…æ—¶]
    A --> D[å•†å“ç¼ºè´§]
    A --> E[ç³»ç»Ÿå¼‚å¸¸]
    
    B --> F[è°ƒç”¨å…³å•æ¥å£]
    C --> F
    D --> F
    E --> F
    
    F --> G[è®¢å•çŠ¶æ€å˜æ›´ä¸ºCLOSED]
    G --> H[é‡Šæ”¾åº“å­˜]
    G --> I[æ¸…ç†ç¼“å­˜]
```

**æ¥å£è°ƒç”¨ï¼š**

```bash
POST /v3/pay/transactions/out-trade-no/{out_trade_no}/close
Host: api.mch.weixin.qq.com
Authorization: WECHATPAY2-SHA256-RSA2048 mchid="1900000001",...
Accept: application/json
Content-Type: application/json

{
  "mchid": "1900000001"
}
```

**å“åº”ç»“æœï¼š**
- æˆåŠŸï¼š`204 No Content`
- å¤±è´¥ï¼šè¿”å›é”™è¯¯ç å’Œé”™è¯¯æè¿°

::: tip æœ€ä½³å®è·µ
- å»ºè®®åœ¨ç”¨æˆ·å–æ¶ˆæ”¯ä»˜æˆ–è®¢å•è¶…æ—¶æ—¶åŠæ—¶å…³é—­è®¢å•
- å…³å•æˆåŠŸååº”è¯¥é‡Šæ”¾ç›¸å…³åº“å­˜
- å·²æ”¯ä»˜çš„è®¢å•æ— æ³•å…³é—­ï¼Œéœ€è¦é€šè¿‡é€€æ¬¾å¤„ç†
:::

### JSAPIæ”¯ä»˜å›è°ƒ

å½“ç”¨æˆ·æˆåŠŸæ”¯ä»˜è®¢å•åï¼Œå¾®ä¿¡æ”¯ä»˜ä¼šå‘å•†æˆ·é¢„å…ˆè®¾ç½®çš„å›è°ƒåœ°å€å‘é€æ”¯ä»˜ç»“æœé€šçŸ¥ã€‚

**å›è°ƒé‡è¯•æœºåˆ¶ï¼š**

```mermaid
graph LR
    A[æ”¯ä»˜æˆåŠŸ] --> B[å‘é€å›è°ƒ]
    B --> C{å•†æˆ·å“åº”}
    C -->|æˆåŠŸ200/204| D[å›è°ƒå®Œæˆ]
    C -->|å¤±è´¥4xx/5xx| E[ç­‰å¾…é‡è¯•]
    C -->|è¶…æ—¶5s| E
    
    E --> F[15såé‡è¯•]
    F --> G[15såé‡è¯•]
    G --> H[30såé‡è¯•]
    H --> I[3måé‡è¯•]
    I --> J[æœ€å¤šé‡è¯•15æ¬¡]
```

**å›è°ƒè¯·æ±‚å¤´ï¼š**

```bash
Wechatpay-Serial: éªŒç­¾çš„å¾®ä¿¡æ”¯ä»˜å¹³å°è¯ä¹¦åºåˆ—å·
Wechatpay-Signature: éªŒç­¾çš„ç­¾åå€¼
Wechatpay-Timestamp: éªŒç­¾çš„æ—¶é—´æˆ³
Wechatpay-Nonce: éªŒç­¾çš„éšæœºä¸²
```

**å›è°ƒè¯·æ±‚ä½“ï¼š**

```js
{
  "id": "EV-2018022511223320873",              // é€šçŸ¥ID
  "create_time": "2015-05-20T13:29:35+08:00", // é€šçŸ¥åˆ›å»ºæ—¶é—´
  "resource_type": "encrypt-resource",         // é€šçŸ¥æ•°æ®ç±»å‹
  "event_type": "TRANSACTION.SUCCESS",         // é€šçŸ¥ç±»å‹
  "summary": "æ”¯ä»˜æˆåŠŸ",                        // å›è°ƒæ‘˜è¦
  "resource": {
    "original_type": "transaction",            // åŸå§‹æ•°æ®ç±»å‹
    "algorithm": "AEAD_AES_256_GCM",          // åŠ å¯†ç®—æ³•
    "ciphertext": "...",                      // åŠ å¯†æ•°æ®
    "associated_data": "",                     // é™„åŠ æ•°æ®
    "nonce": ""                               // éšæœºä¸²
  }
}
```

**å›è°ƒå¤„ç†æµç¨‹ï¼š**

```js
// Node.js ç¤ºä¾‹
const crypto = require('crypto');

// ğŸ”¸ éªŒç­¾å‡½æ•°
function verifySignature(signature, timestamp, nonce, body, cert) {
  const signStr = `${timestamp}\n${nonce}\n${body}\n`;
  const verify = crypto.createVerify('RSA-SHA256');
  verify.update(signStr);
  return verify.verify(cert, signature, 'base64');
}

// ğŸ”¸ è§£å¯†å‡½æ•°
function decryptData(ciphertext, key, nonce, associatedData) {
  const decipher = crypto.createDecipherGCM('aes-256-gcm', key);
  decipher.setAuthTag(Buffer.from(ciphertext.slice(-32), 'hex'));
  if (associatedData) {
    decipher.setAAD(Buffer.from(associatedData));
  }
  
  let decrypted = decipher.update(ciphertext.slice(0, -32), 'base64', 'utf8');
  decrypted += decipher.final('utf8');
  return JSON.parse(decrypted);
}

// ğŸ”¸ å›è°ƒå¤„ç†ä¸»å‡½æ•°
app.post('/wxpay/callback', (req, res) => {
  const signature = req.headers['wechatpay-signature'];
  const timestamp = req.headers['wechatpay-timestamp'];
  const nonce = req.headers['wechatpay-nonce'];
  const body = JSON.stringify(req.body);
  
  // 1. éªŒç­¾
  if (!verifySignature(signature, timestamp, nonce, body, wxpayCert)) {
    return res.status(400).json({ code: 'FAIL', message: 'éªŒç­¾å¤±è´¥' });
  }
  
  // 2. è§£å¯†
  const resource = req.body.resource;
  const decryptedData = decryptData(
    resource.ciphertext,
    apiv3Key,
    resource.nonce,
    resource.associated_data
  );
  
  // 3. å¤„ç†ä¸šåŠ¡é€»è¾‘
  if (decryptedData.trade_state === 'SUCCESS') {
    // æ”¯ä»˜æˆåŠŸå¤„ç†
    updateOrderStatus(decryptedData.out_trade_no, 'paid');
    // å‘è´§é€»è¾‘
    processDelivery(decryptedData.out_trade_no);
    
    // 4. è¿”å›æˆåŠŸå“åº”
    res.status(200).json({ code: 'SUCCESS', message: 'å¤„ç†æˆåŠŸ' });
  } else {
    // æ”¯ä»˜å¤±è´¥å¤„ç†
    res.status(200).json({ code: 'SUCCESS', message: 'å·²å¤„ç†' });
  }
});
```

**å›è°ƒåº”ç­”è¦æ±‚ï¼š**

| åœºæ™¯ | HTTPçŠ¶æ€ç  | åº”ç­”å†…å®¹ |
|------|------------|----------|
| éªŒç­¾æˆåŠŸ | 200 æˆ– 204 | æ— éœ€åº”ç­”ä½“ |
| éªŒç­¾å¤±è´¥ | 4xx æˆ– 5xx | `{"code":"FAIL","message":"å¤±è´¥åŸå› "}` |

::: warning å®‰å…¨è¦æ±‚
- å¿…é¡»éªŒè¯å›è°ƒè¯·æ±‚çš„ç­¾åï¼Œç¡®ä¿æ¥æºå¯ä¿¡
- å»ºè®®å¯¹ç›¸åŒè®¢å•çš„é‡å¤å›è°ƒè¿›è¡Œå¹‚ç­‰å¤„ç†
- å›è°ƒå¤„ç†å®Œæˆååº”ç«‹å³è¿”å›200çŠ¶æ€ç 
- å•†æˆ·æœåŠ¡å™¨å¿…é¡»å¯¹å¾®ä¿¡æ”¯ä»˜å›è°ƒIPå¼€æ”¾è®¿é—®æƒé™
:::

### JSAPIç”³è¯·é€€æ¬¾

åœ¨äº¤æ˜“å®Œæˆåçš„ä¸€å¹´å†…ï¼Œå•†æˆ·å¯é€šè¿‡é€€æ¬¾æ¥å£å°†æ”¯ä»˜é‡‘é¢çš„å…¨éƒ¨æˆ–éƒ¨åˆ†åŸè·¯é€€è¿˜ç»™ç”¨æˆ·ã€‚

**é€€æ¬¾ä¸šåŠ¡æµç¨‹ï¼š**

```mermaid
graph TD
    A[ç”¨æˆ·ç”³è¯·é€€æ¬¾] --> B[å•†æˆ·å®¡æ ¸]
    B --> C{å®¡æ ¸ç»“æœ}
    C -->|é€šè¿‡| D[è°ƒç”¨é€€æ¬¾æ¥å£]
    C -->|æ‹’ç»| E[æ‹’ç»é€€æ¬¾]
    
    D --> F[å¾®ä¿¡å¤„ç†é€€æ¬¾]
    F --> G[é€€æ¬¾ç»“æœå›è°ƒ]
    G --> H[æ›´æ–°è®¢å•çŠ¶æ€]
    H --> I[é€šçŸ¥ç”¨æˆ·]
    
    E --> J[é€šçŸ¥ç”¨æˆ·è¢«æ‹’åŸå› ]
```

**æ¥å£ä¿¡æ¯ï¼š**
- **è¯·æ±‚æ–¹å¼**ï¼š`POST`
- **è¯·æ±‚URL**ï¼š`https://api.mch.weixin.qq.com/v3/refund/domestic/refunds`

**è¯·æ±‚å‚æ•°ï¼š**

```js
{
  // ğŸ”¸ è®¢å•æ ‡è¯†ï¼ˆäºŒé€‰ä¸€ï¼‰
  "transaction_id": "1217752501201407033233368018",  // å¾®ä¿¡æ”¯ä»˜è®¢å•å·
  "out_trade_no": "1217752501201407033233368018",    // å•†æˆ·è®¢å•å·
  
  // ğŸ”¸ é€€æ¬¾æ ‡è¯†
  "out_refund_no": "1217752501201407033233368018",   // å•†æˆ·é€€æ¬¾å•å·
  "reason": "å•†å“å·²å”®å®Œ",                             // é€€æ¬¾åŸå› 
  "notify_url": "https://weixin.qq.com",             // é€€æ¬¾ç»“æœå›è°ƒURL
  
  // ğŸ”¸ é€€æ¬¾é‡‘é¢
  "amount": {
    "refund": 888,                                   // é€€æ¬¾é‡‘é¢ï¼ˆåˆ†ï¼‰
    "total": 888,                                    // è®¢å•æ€»é‡‘é¢ï¼ˆåˆ†ï¼‰
    "currency": "CNY",                               // å¸ç§
    "from": [{                                       // é€€æ¬¾å‡ºèµ„è´¦æˆ·
      "account": "AVAILABLE",                        // è´¦æˆ·ç±»å‹
      "amount": 444                                  // å‡ºèµ„é‡‘é¢
    }]
  },
  
  // ğŸ”¸ é€€æ¬¾å•†å“è¯¦æƒ…
  "goods_detail": [{
    "merchant_goods_id": "1217752501201407033233368018", // å•†æˆ·å•†å“ID
    "wechatpay_goods_id": "1001",                        // å¾®ä¿¡å•†å“ID
    "goods_name": "iPhone6s 16G",                        // å•†å“åç§°
    "unit_price": 528800,                                // å•†å“å•ä»·
    "refund_amount": 528800,                             // é€€æ¬¾é‡‘é¢
    "refund_quantity": 1                                 // é€€æ¬¾æ•°é‡
  }],
  
  // ğŸ”¸ é€€æ¬¾èµ„é‡‘æ¥æº
  "funds_account": "AVAILABLE"                           // èµ„é‡‘è´¦æˆ·
}
```

**é€€æ¬¾èµ„é‡‘æ¥æºè¯´æ˜ï¼š**

| èµ„é‡‘æ¥æº | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|----------|------|----------|
| `AVAILABLE` | å¯ç”¨ä½™é¢ | æ™®é€šé€€æ¬¾ |
| `UNSETTLED` | æœªç»“ç®—èµ„é‡‘ | é¢„ä»˜æŠ¼é‡‘é€€æ¬¾ |

**åº”ç­”å‚æ•°ï¼š**

```js
{
  "refund_id": "50000000382019052709732678859",      // å¾®ä¿¡é€€æ¬¾å•å·
  "out_refund_no": "1217752501201407033233368018",   // å•†æˆ·é€€æ¬¾å•å·
  "transaction_id": "1217752501201407033233368018",  // å¾®ä¿¡æ”¯ä»˜è®¢å•å·
  "out_trade_no": "1217752501201407033233368018",    // å•†æˆ·è®¢å•å·
  "channel": "ORIGINAL",                             // é€€æ¬¾æ¸ é“
  "user_received_account": "æ‹›å•†é“¶è¡Œä¿¡ç”¨å¡0403",       // é€€æ¬¾å…¥è´¦è´¦æˆ·
  "success_time": "2020-12-01T16:18:12+08:00",      // é€€æ¬¾æˆåŠŸæ—¶é—´
  "create_time": "2020-12-01T16:18:12+08:00",       // é€€æ¬¾å—ç†æ—¶é—´
  "status": "SUCCESS",                               // é€€æ¬¾çŠ¶æ€
  "funds_account": "UNSETTLED",                      // èµ„é‡‘è´¦æˆ·
  
  // ğŸ”¸ é€€æ¬¾é‡‘é¢è¯¦æƒ…
  "amount": {
    "total": 100,                                    // è®¢å•æ€»é‡‘é¢
    "refund": 100,                                   // é€€æ¬¾é‡‘é¢
    "payer_total": 90,                              // ç”¨æˆ·å®é™…æ”¯ä»˜
    "payer_refund": 90,                             // ç”¨æˆ·å®é™…é€€æ¬¾
    "settlement_refund": 100,                       // ç»“ç®—é€€æ¬¾é‡‘é¢
    "settlement_total": 100,                        // ç»“ç®—æ€»é‡‘é¢
    "discount_refund": 10,                          // ä¼˜æƒ é€€æ¬¾é‡‘é¢
    "currency": "CNY",                              // å¸ç§
    "refund_fee": 100                               // é€€æ¬¾æ‰‹ç»­è´¹
  }
}
```

**é€€æ¬¾çŠ¶æ€è¯´æ˜ï¼š**

| çŠ¶æ€ | è¯´æ˜ | å¤„ç†å»ºè®® |
|------|------|----------|
| `SUCCESS` | é€€æ¬¾æˆåŠŸ | é€šçŸ¥ç”¨æˆ·é€€æ¬¾å®Œæˆ |
| `CLOSED` | é€€æ¬¾å…³é—­ | æŸ¥çœ‹å…³é—­åŸå›  |
| `PROCESSING` | é€€æ¬¾å¤„ç†ä¸­ | ç»§ç»­å…³æ³¨çŠ¶æ€ |
| `ABNORMAL` | é€€æ¬¾å¼‚å¸¸ | è”ç³»å¾®ä¿¡å®¢æœ |

### JSAPIæŸ¥è¯¢é€€æ¬¾

å•†æˆ·å¯é€šè¿‡å•†æˆ·é€€æ¬¾å•å·æŸ¥è¯¢é€€æ¬¾è¯¦æƒ…ã€‚

**æ¥å£è°ƒç”¨ï¼š**

```bash
GET /v3/refund/domestic/refunds/{out_refund_no}
Host: api.mch.weixin.qq.com
Authorization: WECHATPAY2-SHA256-RSA2048 mchid="1900000001",...
Accept: application/json
```

**åº”ç­”å‚æ•°ï¼š**

åº”ç­”å‚æ•°ä¸ç”³è¯·é€€æ¬¾æ¥å£è¿”å›çš„å‚æ•°ç»“æ„ç›¸åŒï¼ŒåŒ…å«é€€æ¬¾çš„å®Œæ•´ä¿¡æ¯ã€‚

### JSAPIé€€æ¬¾å›è°ƒ

å½“é€€æ¬¾å•çŠ¶æ€å‘ç”Ÿå˜æ›´æ—¶ï¼Œå¾®ä¿¡æ”¯ä»˜ä¼šå‘å•†æˆ·é¢„è®¾çš„å›è°ƒåœ°å€å‘é€é€šçŸ¥ã€‚

**å›è°ƒå¤„ç†ç¤ºä¾‹ï¼š**

```js
app.post('/wxpay/refund-callback', (req, res) => {
  // éªŒç­¾å’Œè§£å¯†è¿‡ç¨‹ä¸æ”¯ä»˜å›è°ƒç›¸åŒ
  const decryptedData = decryptRefundData(req.body);
  
  if (decryptedData.refund_status === 'SUCCESS') {
    // é€€æ¬¾æˆåŠŸå¤„ç†
    updateRefundStatus(decryptedData.out_refund_no, 'success');
    notifyUserRefundSuccess(decryptedData.out_trade_no);
    
    res.status(200).json({ code: 'SUCCESS', message: 'å¤„ç†æˆåŠŸ' });
  } else {
    // é€€æ¬¾å¤±è´¥å¤„ç†
    handleRefundFail(decryptedData);
    res.status(200).json({ code: 'SUCCESS', message: 'å·²å¤„ç†' });
  }
});
```

### JSAPIè´¦å•ä¸‹è½½

å¾®ä¿¡æ”¯ä»˜æä¾›äº¤æ˜“è´¦å•å’Œèµ„é‡‘è´¦å•çš„ä¸‹è½½åŠŸèƒ½ï¼Œå¸®åŠ©å•†æˆ·è¿›è¡Œå¯¹è´¦å’Œè´¢åŠ¡ç®¡ç†ã€‚

**è´¦å•ç±»å‹å¯¹æ¯”ï¼š**

| è´¦å•ç±»å‹ | å†…å®¹ | ç”¨é€” |
|----------|------|------|
| äº¤æ˜“è´¦å• | äº¤æ˜“æ˜ç»†ã€é‡‘é¢ã€æ—¶é—´ç­‰ | è®¢å•æ ¸å¯¹ã€é€€æ¬¾å®¡æŸ¥ |
| èµ„é‡‘è´¦å• | èµ„é‡‘æµæ°´ã€æ”¶æ”¯è®°å½• | è´¢åŠ¡å¯¹è´¦ã€èµ„é‡‘ç¡®è®¤ |

**ç”³è¯·äº¤æ˜“è´¦å•ï¼š**

```bash
GET /v3/bill/tradebill?bill_date=2019-06-11&bill_type=ALL&tar_type=GZIP
Host: api.mch.weixin.qq.com
Authorization: WECHATPAY2-SHA256-RSA2048 mchid="1900000001",...
Accept: application/json
```

**æŸ¥è¯¢å‚æ•°ï¼š**

| å‚æ•° | å¿…å¡« | è¯´æ˜ |
|------|------|------|
| `bill_date` | æ˜¯ | è´¦å•æ—¥æœŸï¼Œæ ¼å¼ï¼šyyyy-MM-dd |
| `bill_type` | å¦ | SUCCESS/REFUND/ALLï¼Œé»˜è®¤ALL |
| `tar_type` | å¦ | GZIPå‹ç¼©ï¼Œé»˜è®¤æ•°æ®æµ |

**ç”³è¯·èµ„é‡‘è´¦å•ï¼š**

```bash
GET /v3/bill/fundflowbill?bill_date=2019-06-11&account_type=BASIC&tar_type=GZIP
Host: api.mch.weixin.qq.com
Authorization: WECHATPAY2-SHA256-RSA2048 mchid="1900000001",...
Accept: application/json
```

**åº”ç­”å‚æ•°ï¼š**

```js
{
  "hash_type": "SHA1",                                    // å“ˆå¸Œç±»å‹
  "hash_value": "79bb0f45fc4c42234a918000b2668d689e2bde04", // å“ˆå¸Œå€¼
  "download_url": "https://api.mch.weixin.qq.com/v3/bill/downloadurl?token=xxx" // ä¸‹è½½åœ°å€
}
```

**ä¸‹è½½è´¦å•ï¼š**

```bash
curl https://api.mch.weixin.qq.com/v3/billdownload/file?token=xxx \
  -H 'Authorization: WECHATPAY2-SHA256-RSA2048 mchid="1900000001",...'
```

::: tip è´¦å•å¤„ç†å»ºè®®
- è´¦å•æ¯æ—¥10ç‚¹åç”Ÿæˆï¼Œä»…æ”¯æŒè¿‘3ä¸ªæœˆçš„è´¦å•ä¸‹è½½
- å»ºè®®ä½¿ç”¨GZIPå‹ç¼©æ ¼å¼å‡å°‘ä¸‹è½½æ—¶é—´
- ä¸‹è½½ååº”éªŒè¯hashå€¼ç¡®ä¿æ–‡ä»¶å®Œæ•´æ€§
- è´¦å•å¯ç”¨äºè‡ªåŠ¨åŒ–å¯¹è´¦å’Œè´¢åŠ¡æŠ¥è¡¨ç”Ÿæˆ
:::

## ğŸ“² APPæ”¯ä»˜

APPæ”¯ä»˜æä¾›å•†æˆ·åœ¨è‡ªå·±çš„APPä¸­ä½¿ç”¨å¾®ä¿¡æ”¯ä»˜æ”¶æ¬¾çš„èƒ½åŠ›ã€‚

### APPæ”¯ä»˜æµç¨‹

**æ•´ä½“æµç¨‹å›¾ï¼š**

```mermaid
sequenceDiagram
    participant A as APPå®¢æˆ·ç«¯
    participant S as å•†æˆ·æœåŠ¡å™¨
    participant W as å¾®ä¿¡æ”¯ä»˜
    participant WX as å¾®ä¿¡å®¢æˆ·ç«¯
    
    A->>S: 1. é€‰æ‹©å•†å“ï¼Œå‘èµ·æ”¯ä»˜
    S->>W: 2. è°ƒç”¨APPä¸‹å•æ¥å£
    W->>S: 3. è¿”å›prepay_id
    S->>A: 4. è¿”å›æ”¯ä»˜å‚æ•°
    A->>WX: 5. è°ƒç”¨å¾®ä¿¡SDKå”¤èµ·æ”¯ä»˜
    WX->>W: 6. ç”¨æˆ·ç¡®è®¤æ”¯ä»˜
    W->>S: 7. æ”¯ä»˜ç»“æœå›è°ƒ
    W->>WX: 8. è¿”å›æ”¯ä»˜ç»“æœ
    WX->>A: 9. è¿”å›APP
    A->>S: 10. æŸ¥è¯¢æ”¯ä»˜ç»“æœ
```

![alt text](image-36.png)

**å¼€å‘æµç¨‹ï¼š**
![alt text](image-39.png)

### APP SDKé›†æˆ

**å¹³å°æ”¯æŒï¼š**

| å¹³å° | SDK | æ–‡æ¡£é“¾æ¥ |
|------|-----|----------|
| Android | OpenSDK | https://developers.weixin.qq.com/doc/oplatform/Mobile_App/Access_Guide/Android.html |
| iOS | OpenSDK | https://developers.weixin.qq.com/doc/oplatform/Mobile_App/Access_Guide/iOS.html |
| é¸¿è’™ | OpenSDK | https://developers.weixin.qq.com/doc/oplatform/Mobile_App/Access_Guide/HarmonyOS.html |

**SDKæ ¡éªŒæœºåˆ¶ï¼š**

```mermaid
graph TD
    A[APPè°ƒç”¨SDK] --> B[å¾®ä¿¡æ ¡éªŒ]
    B --> C{åº”ç”¨ä¿¡æ¯åŒ¹é…}
    C -->|åŒ¹é…| D[è°ƒèµ·æ”¯ä»˜]
    C -->|ä¸åŒ¹é…| E[è°ƒèµ·å¤±è´¥]
    
    B --> F[åº”ç”¨åŒ…å]
    B --> G[åº”ç”¨ç­¾å]
    B --> H[Bundle ID]
    B --> I[Identifier]
```

**é‡è¦é…ç½®è¦æ±‚ï¼š**
- Android/é¸¿è’™ï¼šåº”ç”¨åŒ…åå’Œåº”ç”¨ç­¾åå¿…é¡»ä¸å¼€æ”¾å¹³å°æ³¨å†Œä¿¡æ¯ä¸€è‡´
- iOSï¼šBundle IDå¿…é¡»ä¸å¼€æ”¾å¹³å°æ³¨å†Œä¿¡æ¯ä¸€è‡´
- å¯åœ¨å¼€æ”¾å¹³å°ã€ç®¡ç†ä¸­å¿ƒ â†’ ç§»åŠ¨åº”ç”¨ â†’ è¯¦æƒ… â†’ å¼€å‘é…ç½®ã€‘æŸ¥çœ‹é…ç½®ä¿¡æ¯

### APPä¸‹å•ä¸è°ƒèµ·

**1. APPä¸‹å•æ¥å£**

```bash
POST /v3/pay/transactions/app
Host: api.mch.weixin.qq.com
Authorization: WECHATPAY2-SHA256-RSA2048 mchid="1900000001",...
Content-Type: application/json
```

è¯·æ±‚å‚æ•°ä¸JSAPIæ”¯ä»˜åŸºæœ¬ç›¸åŒï¼Œåªæ˜¯æ¥å£è·¯å¾„ä¸åŒã€‚

**2. è°ƒèµ·æ”¯ä»˜ä»£ç ç¤ºä¾‹**

**Androidç¤ºä¾‹ï¼š**

```java
// åˆå§‹åŒ–å¾®ä¿¡API
private IWXAPI api;

// åœ¨onCreateä¸­åˆå§‹åŒ–
api = WXAPIFactory.createWXAPI(this, APP_ID, true);
api.registerApp(APP_ID);

// è°ƒèµ·æ”¯ä»˜
private void startPay(String prepayId) {
    PayReq request = new PayReq();
    request.appId = "wxd930ea5d5a258f4f";           // åº”ç”¨ID
    request.partnerId = "1900000109";                // å•†æˆ·å·
    request.prepayId = prepayId;                     // é¢„æ”¯ä»˜è®¢å•å·
    request.packageValue = "Sign=WXPay";             // å›ºå®šå€¼
    request.nonceStr = generateNonceStr();           // éšæœºå­—ç¬¦ä¸²
    request.timeStamp = String.valueOf(System.currentTimeMillis() / 1000); // æ—¶é—´æˆ³
    request.sign = generateSign(request);            // ç­¾å
    
    api.sendReq(request);
}

// ç”Ÿæˆéšæœºå­—ç¬¦ä¸²
private String generateNonceStr() {
    return UUID.randomUUID().toString().replace("-", "");
}

// ç”Ÿæˆç­¾å
private String generateSign(PayReq request) {
    // ä½¿ç”¨å•†æˆ·ç§é’¥è¿›è¡ŒRSAç­¾å
    String signStr = String.format("appid=%s&noncestr=%s&package=%s&partnerid=%s&prepayid=%s&timestamp=%s",
        request.appId, request.nonceStr, request.packageValue, 
        request.partnerId, request.prepayId, request.timeStamp);
    return RSAUtils.sign(signStr, privateKey);
}
```

**iOSç¤ºä¾‹ï¼š**

```objc
// è°ƒèµ·æ”¯ä»˜
- (void)startPayWithPrepayId:(NSString *)prepayId {
    PayReq *request = [[PayReq alloc] init];
    request.appId = @"wxd930ea5d5a258f4f";
    request.partnerId = @"1900000109";
    request.prepayId = prepayId;
    request.packageValue = @"Sign=WXPay";
    request.nonceStr = [self generateNonceStr];
    request.timeStamp = [NSString stringWithFormat:@"%ld", (long)[[NSDate date] timeIntervalSince1970]];
    request.sign = [self generateSign:request];
    
    [WXApi sendReq:request completion:^(BOOL success) {
        if (success) {
            NSLog(@"å¾®ä¿¡æ”¯ä»˜è°ƒèµ·æˆåŠŸ");
        } else {
            NSLog(@"å¾®ä¿¡æ”¯ä»˜è°ƒèµ·å¤±è´¥");
        }
    }];
}
```

**é¸¿è’™ç¤ºä¾‹ï¼š**

```javascript
// è°ƒèµ·æ”¯ä»˜
private startPay(prepayId: string) {
  let req = new wxopensdk.PayReq();
  req.appId = 'wxd930ea5d5a258f4f';
  req.partnerId = '1900000109';
  req.prepayId = prepayId;
  req.packageValue = 'Sign=WXPay';
  req.nonceStr = this.generateNonceStr();
  req.timeStamp = Math.floor(Date.now() / 1000).toString();
  req.sign = this.generateSign(req);
  
  this.api.sendReq(this.context, req);
}
```

### APPå›è°ƒå¤„ç†

**æ”¯ä»˜ç»“æœå›è°ƒï¼š**

```java
// Androidå›è°ƒå¤„ç†
@Override
public void onResp(BaseResp resp) {
    if (resp.getType() == ConstantsAPI.COMMAND_PAY_BY_WX) {
        AlertDialog.Builder builder = new AlertDialog.Builder(this);
        builder.setTitle("æ”¯ä»˜ç»“æœ");
        
        switch (resp.errCode) {
            case 0:
                // æ”¯ä»˜æˆåŠŸ
                builder.setMessage("æ”¯ä»˜æˆåŠŸ");
                // å»ºè®®è°ƒç”¨åç«¯æ¥å£ç¡®è®¤æ”¯ä»˜çŠ¶æ€
                checkPaymentStatus();
                break;
            case -1:
                // æ”¯ä»˜å¤±è´¥
                builder.setMessage("æ”¯ä»˜å¤±è´¥ï¼š" + resp.errStr);
                break;
            case -2:
                // ç”¨æˆ·å–æ¶ˆ
                builder.setMessage("ç”¨æˆ·å–æ¶ˆæ”¯ä»˜");
                break;
            default:
                builder.setMessage("æ”¯ä»˜å¼‚å¸¸");
                break;
        }
        
        builder.show();
    }
}

// æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€
private void checkPaymentStatus() {
    // è°ƒç”¨åç«¯æ¥å£æŸ¥è¯¢è®¢å•çŠ¶æ€
    // ç¡®ä¿è®¢å•ç¡®å®å·²ç»æ”¯ä»˜æˆåŠŸ
}
```

**å›è°ƒé”™è¯¯ç è¯´æ˜ï¼š**

| é”™è¯¯ç  | è¯´æ˜ | å¤„ç†å»ºè®® |
|--------|------|----------|
| 0 | æ”¯ä»˜æˆåŠŸ | è°ƒç”¨æŸ¥å•æ¥å£ç¡®è®¤ |
| -1 | æ”¯ä»˜å¤±è´¥ | æ£€æŸ¥ç­¾åå’Œå‚æ•° |
| -2 | ç”¨æˆ·å–æ¶ˆ | å…è®¸é‡æ–°æ”¯ä»˜ |

::: warning é‡è¦æé†’
- APPæ”¯ä»˜å›è°ƒåªèƒ½ä½œä¸ºæ”¯ä»˜ç»“æœçš„åˆæ­¥åˆ¤æ–­
- å¿…é¡»é€šè¿‡æœåŠ¡ç«¯æŸ¥å•æ¥å£ç¡®è®¤æœ€ç»ˆæ”¯ä»˜çŠ¶æ€
- å»ºè®®åœ¨å›è°ƒæˆåŠŸåç«‹å³è°ƒç”¨æŸ¥å•æ¥å£
:::

## ğŸŒ H5æ”¯ä»˜

H5æ”¯ä»˜æä¾›å•†æˆ·åœ¨ç§»åŠ¨å®¢æˆ·ç«¯æµè§ˆå™¨ç½‘é¡µä¸­ä½¿ç”¨å¾®ä¿¡æ”¯ä»˜æ”¶æ¬¾çš„èƒ½åŠ›ã€‚

### H5æ”¯ä»˜æµç¨‹

**æ”¯ä»˜æµç¨‹å›¾ï¼š**

![alt text](image-40.png)

**ä¸šåŠ¡æµç¨‹ï¼š**
![alt text](image-41.png)

### H5åŸŸåé…ç½®

**ç”³è¯·H5æ”¯ä»˜æƒé™ï¼š**

```mermaid
graph TD
    A[å•†æˆ·å¹³å°] --> B[äº§å“ä¸­å¿ƒ]
    B --> C[H5æ”¯ä»˜]
    C --> D[ç”³è¯·å¼€é€š]
    D --> E[å¡«å†™æ”¯ä»˜åŸŸå]
    E --> F[ä¸Šä¼ ICPå¤‡æ¡ˆæˆªå›¾]
    F --> G[ç»è¥åœºæ‰€ç®€ä»‹]
    G --> H[æäº¤ç”³è¯·]
    H --> I[ç­‰å¾…å®¡æ ¸]
    I --> J[å®¡æ ¸é€šè¿‡]
    J --> K[å¼€é€šH5æ”¯ä»˜æƒé™]
```

**é…ç½®è¦æ±‚ï¼š**
- æ”¯ä»˜åŸŸåå¿…é¡»å®ŒæˆICPå¤‡æ¡ˆ
- åŸŸåå¿…é¡»ä¸å®é™…æ”¯ä»˜é¡µé¢ä¸€è‡´
- å®¡æ ¸å‘¨æœŸï¼š7ä¸ªå·¥ä½œæ—¥å†…

### H5è°ƒèµ·æ”¯ä»˜

**1. H5ä¸‹å•**

```bash
POST /v3/pay/transactions/h5
Host: api.mch.weixin.qq.com
Authorization: WECHATPAY2-SHA256-RSA2048 mchid="1900000001",...
Content-Type: application/json
```

**è¯¦ç»†ä¸‹å•æ­¥éª¤ï¼š**
![alt text](image-42.png)

**2. è°ƒèµ·æ”¯ä»˜æµç¨‹**

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant H as H5é¡µé¢
    participant W as å¾®ä¿¡æ”¯ä»˜
    participant WX as å¾®ä¿¡å®¢æˆ·ç«¯
    
    U->>H: 1. ç‚¹å‡»æ”¯ä»˜æŒ‰é’®
    H->>W: 2. è·å–h5_url
    W->>H: 3. è¿”å›æ”¯ä»˜é“¾æ¥
    H->>U: 4. è·³è½¬åˆ°h5_url
    U->>W: 5. å¾®ä¿¡æ”¶é“¶å°ä¸­é—´é¡µ
    W->>WX: 6. è°ƒèµ·å¾®ä¿¡å®¢æˆ·ç«¯
    WX->>U: 7. ç”¨æˆ·ç¡®è®¤æ”¯ä»˜
    U->>H: 8. è¿”å›å•†æˆ·é¡µé¢
```

**è°ƒèµ·æ”¯ä»˜ä»£ç ï¼š**

```html
<!-- H5æ”¯ä»˜é¡µé¢ -->
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾®ä¿¡æ”¯ä»˜</title>
</head>
<body>
    <script>
        // è·å–æ”¯ä»˜é“¾æ¥
        function startPay() {
            fetch('/api/h5-pay', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    out_trade_no: 'ORDER123456',
                    total_fee: 100,
                    body: 'æµ‹è¯•å•†å“'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.h5_url) {
                    // è·³è½¬åˆ°å¾®ä¿¡æ”¯ä»˜é¡µé¢
                    window.location.href = data.h5_url;
                } else {
                    alert('è·å–æ”¯ä»˜é“¾æ¥å¤±è´¥');
                }
            });
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥æ”¯ä»˜ç»“æœ
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('pay_result') === 'success') {
                // æ”¯ä»˜æˆåŠŸå¤„ç†
                checkPaymentStatus();
            }
        };
        
        // æ£€æŸ¥æ”¯ä»˜çŠ¶æ€
        function checkPaymentStatus() {
            fetch('/api/order-status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    out_trade_no: 'ORDER123456'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.trade_state === 'SUCCESS') {
                    showSuccessPage();
                } else {
                    showFailPage();
                }
            });
        }
    </script>
</body>
</html>
```

**H5æ”¯ä»˜æ³¨æ„äº‹é¡¹ï¼š**

| åœºæ™¯ | è¦æ±‚ | è¯´æ˜ |
|------|------|------|
| åŸŸåæ ¡éªŒ | å¿…é¡»åœ¨é…ç½®åŸŸåä¸‹ | å¦åˆ™æ— æ³•è°ƒèµ·æ”¯ä»˜ |
| ç”¨æˆ·ä»£ç† | ç§»åŠ¨æµè§ˆå™¨ | éå¾®ä¿¡å†…ç½®æµè§ˆå™¨ |
| ç½‘ç»œç¯å¢ƒ | è‰¯å¥½çš„ç½‘ç»œè¿æ¥ | é¿å…æ”¯ä»˜ä¸­æ–­ |

::: tip H5æ”¯ä»˜ä¼˜åŒ–å»ºè®®
- åœ¨æ”¯ä»˜é¡µé¢æ·»åŠ loadingçŠ¶æ€æç¤º
- å¤„ç†æ”¯ä»˜è¿‡ç¨‹ä¸­çš„ç½‘ç»œå¼‚å¸¸
- æä¾›å®¢æœè”ç³»æ–¹å¼
- ä¼˜åŒ–ç§»åŠ¨ç«¯é¡µé¢ä½“éªŒ
:::

## ğŸ–¥ï¸ Nativeæ”¯ä»˜

Nativeæ”¯ä»˜æä¾›å•†æˆ·åœ¨PCç«¯ç½‘é¡µæµè§ˆå™¨ä¸­ä½¿ç”¨å¾®ä¿¡æ”¯ä»˜æ”¶æ¬¾çš„èƒ½åŠ›ã€‚

### Nativeæ”¯ä»˜æµç¨‹

**æ”¯ä»˜æµç¨‹å›¾ï¼š**
![alt text](image-43.png)

**å¼€å‘æµç¨‹ï¼š**
![alt text](image-44.png)

### NativeäºŒç»´ç ç”Ÿæˆ

**1. Nativeä¸‹å•**

```bash
POST /v3/pay/transactions/native
Host: api.mch.weixin.qq.com
Authorization: WECHATPAY2-SHA256-RSA2048 mchid="1900000001",...
Content-Type: application/json
```

**2. ç”ŸæˆäºŒç»´ç **

```javascript
// å‰ç«¯äºŒç»´ç ç”Ÿæˆç¤ºä¾‹
function generateQRCode(codeUrl) {
    // ä½¿ç”¨qrcode.jsåº“ç”ŸæˆäºŒç»´ç 
    QRCode.toCanvas(document.getElementById('qr-canvas'), codeUrl, {
        width: 256,
        height: 256,
        margin: 2,
        color: {
            dark: '#000000',
            light: '#FFFFFF'
        }
    }, function (error) {
        if (error) {
            console.error('äºŒç»´ç ç”Ÿæˆå¤±è´¥ï¼š', error);
        } else {
            console.log('äºŒç»´ç ç”ŸæˆæˆåŠŸ');
        }
    });
}

// åç«¯ç”ŸæˆäºŒç»´ç 
const QRCode = require('qrcode');

app.post('/api/native-pay', async (req, res) => {
    try {
        // è°ƒç”¨å¾®ä¿¡æ”¯ä»˜ä¸‹å•æ¥å£
        const wxResponse = await callWXPayAPI(req.body);
        const codeUrl = wxResponse.code_url;
        
        // ç”ŸæˆäºŒç»´ç å›¾ç‰‡
        const qrCodeDataURL = await QRCode.toDataURL(codeUrl, {
            width: 256,
            margin: 2
        });
        
        res.json({
            code_url: codeUrl,
            qr_code: qrCodeDataURL
        });
    } catch (error) {
        res.status(500).json({ error: 'ç”ŸæˆäºŒç»´ç å¤±è´¥' });
    }
});
```

### Nativeæ”¯ä»˜å¤„ç†

**å®Œæ•´çš„Nativeæ”¯ä»˜é¡µé¢ï¼š**

```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>å¾®ä¿¡æ”¯ä»˜</title>
    <style>
        .pay-container {
            max-width: 400px;
            margin: 50px auto;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .qr-code {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #eee;
        }
        
        .pay-status {
            margin: 20px 0;
            padding: 10px;
            border-radius: 4px;
        }
        
        .success { background-color: #d4edda; color: #155724; }
        .waiting { background-color: #fff3cd; color: #856404; }
        .failed { background-color: #f8d7da; color: #721c24; }
        
        .countdown {
            font-size: 18px;
            font-weight: bold;
            color: #ff6b6b;
        }
    </style>
</head>
<body>
    <div class="pay-container">
        <h2>å¾®ä¿¡æ”¯ä»˜</h2>
        <p>è®¢å•é‡‘é¢ï¼šÂ¥<span id="amount">1.00</span></p>
        <p>è¯·ä½¿ç”¨å¾®ä¿¡æ‰«æäºŒç»´ç å®Œæˆæ”¯ä»˜</p>
        
        <div class="qr-code">
            <canvas id="qr-canvas"></canvas>
        </div>
        
        <div id="pay-status" class="pay-status waiting">
            ç­‰å¾…æ”¯ä»˜ä¸­...
        </div>
        
        <div class="countdown">
            æ”¯ä»˜å‰©ä½™æ—¶é—´ï¼š<span id="countdown">05:00</span>
        </div>
        
        <button onclick="refreshQRCode()">åˆ·æ–°äºŒç»´ç </button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script>
        let paymentTimer = null;
        let countdownTimer = null;
        let remainingTime = 300; // 5åˆ†é’Ÿ
        
        // åˆå§‹åŒ–æ”¯ä»˜
        function initPayment() {
            fetch('/api/native-pay', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    out_trade_no: 'ORDER' + Date.now(),
                    total_fee: 100,
                    body: 'æµ‹è¯•å•†å“'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.code_url) {
                    generateQRCode(data.code_url);
                    startPaymentCheck();
                    startCountdown();
                } else {
                    showStatus('ç”ŸæˆäºŒç»´ç å¤±è´¥', 'failed');
                }
            });
        }
        
        // ç”ŸæˆäºŒç»´ç 
        function generateQRCode(codeUrl) {
            QRCode.toCanvas(document.getElementById('qr-canvas'), codeUrl, {
                width: 200,
                height: 200,
                margin: 2
            });
        }
        
        // å¼€å§‹æ”¯ä»˜çŠ¶æ€æ£€æŸ¥
        function startPaymentCheck() {
            paymentTimer = setInterval(() => {
                checkPaymentStatus();
            }, 3000); // æ¯3ç§’æ£€æŸ¥ä¸€æ¬¡
        }
        
        // æ£€æŸ¥æ”¯ä»˜çŠ¶æ€
        function checkPaymentStatus() {
            fetch('/api/order-status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    out_trade_no: window.currentOrderNo
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.trade_state === 'SUCCESS') {
                    showStatus('æ”¯ä»˜æˆåŠŸï¼', 'success');
                    clearInterval(paymentTimer);
                    clearInterval(countdownTimer);
                    setTimeout(() => {
                        window.location.href = '/success.html';
                    }, 2000);
                } else if (data.trade_state === 'CLOSED') {
                    showStatus('è®¢å•å·²å…³é—­', 'failed');
                    clearInterval(paymentTimer);
                    clearInterval(countdownTimer);
                }
            });
        }
        
        // å¼€å§‹å€’è®¡æ—¶
        function startCountdown() {
            countdownTimer = setInterval(() => {
                remainingTime--;
                updateCountdown();
                
                if (remainingTime <= 0) {
                    showStatus('æ”¯ä»˜è¶…æ—¶', 'failed');
                    clearInterval(paymentTimer);
                    clearInterval(countdownTimer);
                }
            }, 1000);
        }
        
        // æ›´æ–°å€’è®¡æ—¶æ˜¾ç¤º
        function updateCountdown() {
            const minutes = Math.floor(remainingTime / 60);
            const seconds = remainingTime % 60;
            document.getElementById('countdown').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // æ˜¾ç¤ºçŠ¶æ€
        function showStatus(message, type) {
            const statusEl = document.getElementById('pay-status');
            statusEl.textContent = message;
            statusEl.className = `pay-status ${type}`;
        }
        
        // åˆ·æ–°äºŒç»´ç 
        function refreshQRCode() {
            clearInterval(paymentTimer);
            clearInterval(countdownTimer);
            remainingTime = 300;
            showStatus('ç­‰å¾…æ”¯ä»˜ä¸­...', 'waiting');
            initPayment();
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.onload = function() {
            initPayment();
        };
        
        // é¡µé¢å…³é—­æ—¶æ¸…ç†å®šæ—¶å™¨
        window.onbeforeunload = function() {
            clearInterval(paymentTimer);
            clearInterval(countdownTimer);
        };
    </script>
</body>
</html>
```

**Nativeæ”¯ä»˜æœ€ä½³å®è·µï¼š**

| æ–¹é¢ | å»ºè®® |
|------|------|
| äºŒç»´ç æœ‰æ•ˆæœŸ | å»ºè®®5-10åˆ†é’Ÿ |
| çŠ¶æ€æ£€æŸ¥é¢‘ç‡ | æ¯3-5ç§’æ£€æŸ¥ä¸€æ¬¡ |
| ç”¨æˆ·æç¤º | æ¸…æ™°çš„æ”¯ä»˜çŠ¶æ€æ˜¾ç¤º |
| å¼‚å¸¸å¤„ç† | æä¾›åˆ·æ–°å’Œé‡æ–°æ”¯ä»˜é€‰é¡¹ |

::: warning ä½¿ç”¨æ³¨æ„äº‹é¡¹
- ç”¨æˆ·å¿…é¡»ä½¿ç”¨å¾®ä¿¡"æ‰«ä¸€æ‰«"åŠŸèƒ½æ‰«æäºŒç»´ç 
- ç›´æ¥åœ¨å¾®ä¿¡ä¸­æ‰“å¼€code_urlé“¾æ¥æ— æ³•æ”¯ä»˜
- å»ºè®®åœ¨PCç«¯ä½¿ç”¨ï¼Œç§»åŠ¨ç«¯æ¨èä½¿ç”¨H5æ”¯ä»˜
- äºŒç»´ç è¿‡æœŸåéœ€è¦é‡æ–°ç”Ÿæˆ
:::

## ğŸª ä»˜æ¬¾ç æ”¯ä»˜

ä»˜æ¬¾ç æ”¯ä»˜ç”¨äºçº¿ä¸‹å•†æˆ·æ”¶é“¶åœºæ™¯ï¼Œå•†æˆ·æ”¶é“¶å‘˜ä½¿ç”¨æ‰«ç è®¾å¤‡æ‰«æç”¨æˆ·çš„ä»˜æ¬¾ç å®Œæˆæ”¯ä»˜ã€‚

### ä»˜æ¬¾ç æ”¯ä»˜æµç¨‹

![alt text](image-47.png)

**ä¸šåŠ¡æµç¨‹ï¼š**

```mermaid
sequenceDiagram
    participant C as æ”¶é“¶å‘˜
    participant S as æ”¶é“¶ç³»ç»Ÿ
    participant W as å¾®ä¿¡æ”¯ä»˜
    participant U as ç”¨æˆ·
    
    U->>C: 1. å‡ºç¤ºä»˜æ¬¾ç 
    C->>S: 2. æ‰«æä»˜æ¬¾ç 
    S->>W: 3. æäº¤æ”¯ä»˜è¯·æ±‚
    W->>U: 4. å‘é€æ”¯ä»˜éªŒè¯
    U->>W: 5. ç¡®è®¤æ”¯ä»˜
    W->>S: 6. è¿”å›æ”¯ä»˜ç»“æœ
    S->>C: 7. æ˜¾ç¤ºæ”¯ä»˜ç»“æœ
    C->>U: 8. å®Œæˆäº¤æ˜“
```

### ä»˜æ¬¾ç å•†æˆ·æ”¶é“¶

**è¯·æ±‚å‚æ•°ï¼ˆXMLæ ¼å¼ï¼‰ï¼š**

```xml
<xml>
   <appid>wx2421b1c4370ec43b</appid>
   <attach>è®¢å•é¢å¤–æè¿°</attach>
   <auth_code>120269300684844649</auth_code>  <!-- æ‰«ç æ”¯ä»˜æˆæƒç  -->
   <body>ä»˜æ¬¾ç æ”¯ä»˜æµ‹è¯•</body>
   <device_info>1000</device_info>
   <goods_tag></goods_tag>
   <mch_id>10000100</mch_id>
   <nonce_str>8aaee146b1dee7cec9100add9b96cbe2</nonce_str>
   <out_trade_no>1415757673</out_trade_no>
   <spbill_create_ip>14.17.22.52</spbill_create_ip>
   <time_expire></time_expire>
   <total_fee>1</total_fee>
   <sign>C29DB7DB1FD4136B84AE35604756362C</sign>
</xml>
```

**è¿”å›å‚æ•°ï¼ˆXMLæ ¼å¼ï¼‰ï¼š**

```xml
<xml>
   <return_code><![CDATA[SUCCESS]]></return_code>
   <return_msg><![CDATA[OK]]></return_msg>
   <appid><![CDATA[wx2421b1c4370ec43b]]></appid>
   <mch_id><![CDATA[10000100]]></mch_id>
   <device_info><![CDATA[1000]]></device_info>
   <nonce_str><![CDATA[GOp3TRyMXzbMlkun]]></nonce_str>
   <sign><![CDATA[D6C76CB785F07992CDE05494BB7DF7FD]]></sign>
   <result_code><![CDATA[SUCCESS]]></result_code>
   <openid><![CDATA[oUpF8uN95-Ptaags6E_roPHg7AG0]]></openid>
   <is_subscribe><![CDATA[N]]></is_subscribe>
   <trade_type><![CDATA[MICROPAY]]></trade_type>
   <bank_type><![CDATA[CCB_DEBIT]]></bank_type>
   <total_fee>1</total_fee>
   <coupon_fee>0</coupon_fee>
   <fee_type><![CDATA[CNY]]></fee_type>
   <transaction_id><![CDATA[1008450740201411110005820873]]></transaction_id>
   <out_trade_no><![CDATA[1415757673]]></out_trade_no>
   <attach><![CDATA[è®¢å•é¢å¤–æè¿°]]></attach>
   <time_end><![CDATA[20141111170043]]></time_end>
</xml>
```

**ä»˜æ¬¾ç æ”¯ä»˜ç‰¹ç‚¹ï¼š**

| ç‰¹ç‚¹ | è¯´æ˜ |
|------|------|
| å³æ—¶æ€§ | æ‰«ç åç«‹å³å®Œæˆæ”¯ä»˜ |
| å®‰å…¨æ€§ | ä»˜æ¬¾ç åŠ¨æ€å˜åŒ–ï¼Œé˜²æ­¢æˆªå›¾ç›—ç”¨ |
| ä¾¿æ·æ€§ | ç”¨æˆ·åªéœ€å‡ºç¤ºä»˜æ¬¾ç  |
| é€‚ç”¨åœºæ™¯ | çº¿ä¸‹é—¨åº—ã€è¶…å¸‚ã€é¤å…ç­‰ |

## ğŸ”§ å¼€å‘å·¥å…·ä¸SDK

### å®˜æ–¹SDK

**æœåŠ¡ç«¯SDKï¼š**

| è¯­è¨€ | å®˜æ–¹SDK | ç‰¹ç‚¹ |
|------|---------|------|
| Java | wechatpay-java | å®Œæ•´æ”¯ä»˜åŠŸèƒ½ï¼Œè‡ªåŠ¨ç­¾åéªŒç­¾ |
| PHP | wechatpay-php | æ”¯æŒæ‰€æœ‰æ¥å£ï¼Œç®€å•æ˜“ç”¨ |
| .NET | wechatpay-dotnet | æ”¯æŒ.NET Core/.NET Framework |
| Node.js | wechatpay-nodejs | è½»é‡çº§ï¼Œæ”¯æŒTypeScript |
| Python | wechatpay-python | æ”¯æŒPython 3.6+ |
| Go | wechatpay-go | é«˜æ€§èƒ½ï¼Œæ”¯æŒå¹¶å‘ |

**å®¢æˆ·ç«¯SDKï¼š**

| å¹³å° | SDK | ç‰ˆæœ¬è¦æ±‚ |
|------|-----|----------|
| Android | OpenSDK | Android 4.0+ |
| iOS | OpenSDK | iOS 9.0+ |
| é¸¿è’™ | OpenSDK | HarmonyOS 2.0+ |

### è°ƒè¯•å·¥å…·

**å¾®ä¿¡æ”¯ä»˜è°ƒè¯•å·¥å…·ï¼š**

1. **å¾®ä¿¡å¼€å‘è€…å·¥å…·**
   - å°ç¨‹åºæ”¯ä»˜è°ƒè¯•
   - ç½‘é¡µæˆæƒè°ƒè¯•
   - æ¥å£è°ƒè¯•åŠŸèƒ½

2. **Postmané›†åˆ**
   - æ¥å£æµ‹è¯•æ¨¡æ¿
   - è‡ªåŠ¨ç­¾åç”Ÿæˆ
   - æ‰¹é‡æ¥å£æµ‹è¯•

3. **åœ¨çº¿ç­¾åå·¥å…·**
   - ç­¾åç®—æ³•éªŒè¯
   - å‚æ•°æ ¼å¼æ£€æŸ¥
   - é”™è¯¯æ’æŸ¥è¾…åŠ©

### æœ€ä½³å®è·µ

**å®‰å…¨å®è·µï¼š**

```mermaid
graph TD
    A[å®‰å…¨æœ€ä½³å®è·µ] --> B[è¯ä¹¦ç®¡ç†]
    A --> C[ç­¾åéªŒç­¾]
    A --> D[æ•æ„Ÿä¿¡æ¯åŠ å¯†]
    A --> E[å›è°ƒéªŒè¯]
    A --> F[æ—¥å¿—è®°å½•]
    
    B --> B1[å®šæœŸæ›´æ–°è¯ä¹¦]
    B --> B2[å®‰å…¨å­˜å‚¨ç§é’¥]
    
    C --> C1[ä½¿ç”¨å®˜æ–¹SDK]
    C --> C2[éªŒè¯æ‰€æœ‰å“åº”]
    
    D --> D1[ä½¿ç”¨HTTPS]
    D --> D2[åŠ å¯†å­˜å‚¨æ•æ„Ÿæ•°æ®]
    
    E --> E1[éªŒè¯å›è°ƒç­¾å]
    E --> E2[å¹‚ç­‰æ€§å¤„ç†]
    
    F --> F1[è®°å½•å…³é”®æ“ä½œ]
    F --> F2[å¼‚å¸¸ç›‘æ§å‘Šè­¦]
```

**å¼€å‘å»ºè®®ï¼š**

| é˜¶æ®µ | å»ºè®® |
|------|------|
| å¼€å‘ç¯å¢ƒ | ä½¿ç”¨æ²™ç›’ç¯å¢ƒæµ‹è¯• |
| æµ‹è¯•ç¯å¢ƒ | å°é¢çœŸå®äº¤æ˜“éªŒè¯ |
| ç”Ÿäº§ç¯å¢ƒ | å®Œæ•´çš„ç›‘æ§å’ŒæŠ¥è­¦ |
| è¿ç»´é˜¶æ®µ | å®šæœŸæ£€æŸ¥è¯ä¹¦æœ‰æ•ˆæœŸ |

**é”™è¯¯å¤„ç†ï¼š**

```js
// ç»Ÿä¸€é”™è¯¯å¤„ç†ç¤ºä¾‹
class WXPayError extends Error {
    constructor(code, message, detail) {
        super(message);
        this.code = code;
        this.detail = detail;
    }
}

// æ¥å£è°ƒç”¨é”™è¯¯å¤„ç†
async function callWXPayAPI(apiPath, data) {
    try {
        const response = await fetch(apiPath, {
            method: 'POST',
            headers: {
                'Authorization': generateAuth(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new WXPayError(error.code, error.message, error.detail);
        }
        
        return await response.json();
    } catch (error) {
        // è®°å½•é”™è¯¯æ—¥å¿—
        console.error('å¾®ä¿¡æ”¯ä»˜æ¥å£è°ƒç”¨å¤±è´¥ï¼š', error);
        
        // æ ¹æ®é”™è¯¯ç±»å‹è¿›è¡Œå¤„ç†
        if (error instanceof WXPayError) {
            handleWXPayError(error);
        } else {
            handleNetworkError(error);
        }
        
        throw error;
    }
}
```

::: tip å¼€å‘æ€»ç»“
- ä¼˜å…ˆä½¿ç”¨å®˜æ–¹SDKï¼Œå‡å°‘å¼€å‘å·¥ä½œé‡
- ä¸¥æ ¼æŒ‰ç…§æ¥å£æ–‡æ¡£è¿›è¡Œå¼€å‘å’Œæµ‹è¯•
- é‡è§†å®‰å…¨æ€§ï¼Œå¦¥å–„ä¿ç®¡è¯ä¹¦å’Œå¯†é’¥
- å»ºç«‹å®Œå–„çš„é”™è¯¯å¤„ç†å’Œç›‘æ§æœºåˆ¶
- å®šæœŸå…³æ³¨å¾®ä¿¡æ”¯ä»˜çš„æ›´æ–°å’Œå…¬å‘Š
:::

## ğŸ“š å‚è€ƒèµ„æ–™

- [å¾®ä¿¡æ”¯ä»˜å®˜æ–¹æ–‡æ¡£](https://pay.weixin.qq.com/wiki/doc/apiv3/index.shtml)
- [å¾®ä¿¡å¼€æ”¾å¹³å°](https://open.weixin.qq.com/)
- [å¾®ä¿¡æ”¯ä»˜å•†æˆ·å¹³å°](https://pay.weixin.qq.com/)
- [å¾®ä¿¡æ”¯ä»˜SDKä¸‹è½½](https://pay.weixin.qq.com/wiki/doc/apiv3/open/pay/chapter2_1_1.shtml)

---

> ğŸ’¡ æœ¬æ–‡æ¡£å°†æŒç»­æ›´æ–°ï¼Œè¯·å…³æ³¨å¾®ä¿¡æ”¯ä»˜å®˜æ–¹æ–‡æ¡£çš„æœ€æ–°å˜åŒ–ã€‚å¦‚æœ‰é—®é¢˜æ¬¢è¿äº¤æµè®¨è®ºï¼
